{% extends 'base_template.html' %}

{% block title %}
    Чат
{% endblock %}

{% block other_styles %}
    {% load static %}
{% load crispy_forms_tags %}
{% endblock %}

{% block content %}
{{ group_name|json_script:"group_name" }}
{{ group_type|json_script:"group_type" }}

<div id="chat_messages" class="container" style="background-color: white; border-radius: 10px; padding-bottom: 10px; padding-top: 15px;">
        {% for message in messages %}
            <p><a href="{{ message.sender.get_absolute_url }}"><img src="{{ message.sender.image.url }}" style="    width: 60px;
    height: 60px;
    border-radius: 100px;"> </a> {{ message.sender }}: {{ message.text }}</p>
        {% endfor %}
    </div>
<br>
    <input id="chat-message-input" class="form-control" type="text" size="150" style="width: 500px; display: block;
  margin-left: auto;
  margin-right: auto;">
<button id="chat-message-submit" class="btn btn-success" style="  display: block;
  margin-left: auto;
  margin-right: auto;"> Отправить </button>
<br>
<script>
const group_name = JSON.parse(document.getElementById('group_name').textContent);
const group_type = JSON.parse(document.getElementById('group_type').textContent);
const chat = document.querySelector('#chat_messages');

        const chatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/chatting/'
            + group_type + '/'
            + group_name
            + '/'
        );

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            chat.innerHTML += `<p> <a href="${data.sender_dict['profile_url']}"> <img src="${data.sender_dict['image_url']}" style="    width: 60px;
    height: 60px;
    border-radius: 100px;"> </a> ${data.sender_dict['username']}: ${data.message} </p>`
        };

        chatSocket.onclose = function(e) {
            console.error('Chat closed unexpectedly');
        };

        document.querySelector('#chat-message-input').focus();
        document.querySelector('#chat-message-input').onkeyup = function(e) {
            if (e.keyCode === 13) {  // enter, return
                document.querySelector('#chat-message-submit').click();
            }
        };

        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value.replace(/(<([^>]+)>)/gi, "");;

            if (message.length > 0) {
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                messageInputDom.value = '';
            }
        };
</script>
{% endblock %}
